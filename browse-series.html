<html>
<head>
<style>
body {
  font-family:sans-serif;
  margin:0px;
  border:0px;
}
td {
  font-size:9px;
  border:1px solid black;
  text-align:center;
  cursor:pointer;
}
table {
  border-collapse:collapse;
}
</style>

<script src="https://www.google.com/jsapi"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="js/series.js"></script>
<script>

var grid = {};
var mouseover = {};

function draw_chart_tmp() {
  draw_chart([{country:'United States', category:'Top 1% income share', color:'green'},
              {country:'United States', category:'Top 10% income share', color:'blue'}]);
}

function update_chart() {

  var countries = Object.keys(wtid.countries).sort();

  var series = [];
  var state = [];

  for (var j = 0; j < countries.length; j++) {
    var country = countries[j];
    for (var i = 0; i < wtid_series().length; i++) {
      var category = wtid_series()[i].category;
      var g = grid[country][category];
      if (g.displayed) {
        state = state.concat([country, category]);
      }
      if (g.displayed || country == mouseover.country && category == mouseover.category) {
        series.push({country:country, category:category});
      }
    }
  }

  current_hash = window.btoa(state.join('|')).replace(/=/g, '');
  console.log('Setting hash to ' + current_hash);
  window.location.hash = current_hash;

  draw_chart(series);
}

function set_grid_display(g, displayed) {
  if (g.displayed != displayed) {
    g.displayed = displayed;
    g.element.css('background-color', g.displayed ? 'yellow' : 'white');
  }
}

function clear_wtid_series() {
  console.log('clear all series');
  var countries = Object.keys(wtid.countries).sort();
  for (var j = 0; j < countries.length; j++) {
    var country = countries[j];
    for (var i = 0; i < wtid_series().length; i++) {
      set_grid_display(grid[country][wtid_series()[i].category], false);
    }
  }
}

function toggle_series(e) {
  var series = e.data;
  var start = new Date();
  console.log(series);
  console.log('toggle series ' + JSON.stringify(series));
  var g = grid[series.country][series.category];
  set_grid_display(g, !g.displayed);
  console.log('set ' + series.country + '|' + series.category + ' to ' + g.displayed);
  update_chart();

  console.log('toggle_series took ' + (new Date() - start));
}

function mouseenter(e) {
  mouseover = e.data;
  update_chart();
}

function mouseleave(e) {
  mouseover = {};
  update_chart();
}

var current_hash = null;

function read_hash() {
  var new_hash = window.location.hash.slice(1);
  if (new_hash != current_hash) {
    clear_wtid_series();
    current_hash = new_hash;
    console.log('current_hash is ' + current_hash);
    var deserialized = window.atob(current_hash).split('|');
    console.log('deserialized is ' + deserialized);
    console.log(deserialized);
    while (deserialized.length >= 2) {
      set_grid_display(grid[deserialized.shift()][deserialized.shift()], true);
    }
    update_chart();
  }
}

function init_wtid(data) {
  wtid = data;
  /// Create table of countries and series
  
  var header = $('<tr>');
  header.append($('<td>'));
  for (var i = 0; i < wtid_series().length; i++) {
    var series = wtid_series()[i];
    header.append($('<td>').append(series.category));
  }
  $('#grid').append(header);

  var countries = Object.keys(wtid.countries).sort();
  for (var j = 0; j < countries.length; j++) {
    var country = countries[j];
    grid[country] = {};
    var row = $('<tr>');
    row.append($('<td>').append(country));
    for (var i = 0; i < wtid_series().length; i++) {
      var series = wtid_series()[i];
      var col = $('<td>');
      grid[country][series.category] = {displayed:false, element:col, hilit:false};
      var data = fetch_data(country, series.category);
      if (data.length) {
        col.append(data.length);
        col.click({country:country, category:series.category}, toggle_series);
        col.mouseenter({country:country, category:series.category}, mouseenter);
        col.mouseleave({country:country, category:series.category}, mouseleave);
      }
      row.append(col);
    }
    $('#grid').append(row);
  }
  $('#grid').parent().scroll(function(e){
    $('#gridtop').children().css({position:'relative', left:-this.scrollLeft + 'px'});
    $('#gridleft').children().css({position:'relative', top:-this.scrollTop + 'px'});
  });
  $('#gridtop').append($('#grid').clone(true,true)).css({height:$('#grid td').height() + 5});
  $('#gridleft').append($('#grid').clone(true,true)).css({width:$('#grid td').width() + 5});
  $('#gridtopleft').css({width:$('#gridleft').width() - 2,height:$('#gridtop').height() - 2});
  read_hash();
}

function init() {
  $.get('wtid.json', init_wtid);
  $(window).on('hashchange', read_hash);
}

google.load("visualization", "1", {packages:["corechart"]});
google.setOnLoadCallback(init);

</script>

</head>
<body style="height:100%">
<div id="gridtopleft" style="border:1px solid black; z-index:11; height:50px; position: absolute; background-color:#eee; width:100%; overflow:hidden"></div>
<div id="gridtop" style="z-index:10; height:50px; position: absolute; background-color:#eee; width:100%; overflow:hidden"></div>
<div id="gridleft" style="z-index:10; height:50%; position: absolute; background-color:#eee; width:100px; overflow:hidden"></div>
<div style="height:50%; width:100%; overflow:auto"><table id="grid"></table></div>
<div id="chart" style="show:none; height:50%; width:100%"></div>
</body>
</html>

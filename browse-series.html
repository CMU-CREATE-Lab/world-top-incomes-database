<html>
<head>
<style>
body {
  font-family:sans-serif;
  margin:0px;
  border:0px;
}
td {
  font-size:9px;
  border:1px solid black;
  text-align:center;
  cursor:pointer;
}
table {
  border-collapse:collapse;
}
</style>

<script src="https://www.google.com/jsapi"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script>

var chart;

function example() {
   var data = [];
   data.push(['x', 'red', 'green', 'blue', 'alpha']);
   for (var i = 0; i < 512; i++) {
     data.push([i, i, i*1.5, i*2, i*2.5]);
   }
   chart = new google.visualization.LineChart(document.getElementById('chart'));
}

var wtid;

var computed_source = {};

function to_object(series) {
  var ret = {};
  for (var i = 0; i < series.length; i++) {
    ret[series[i][0]] = series[i][1];
  }
  return ret;
}
  
function fetch_computed_data(country, category) {
  var ret = [];
  if (category.match(/\/ bottom 90% income/)) {
    var source = to_object(fetch_data(country, computed_source[category]));
    var bot90 = to_object(fetch_data(country, 'Bottom 90% average income'));

    var years = Object.keys(source).sort();
    for (var i = 0; i < years.length; i++) {
      var year = years[i];
      if (year in bot90) {
        ret.push([year, source[year] / bot90[year]]);
      }
    }
  }
  return ret;
}

function fetch_data(country, category) {
  var combined = {}, variants, i;
  for (i = 0; i < wtid_series().length; i++) {
    var series = wtid_series()[i];
    if (series.category == category) {
      variants = series.variants;
      break;
    }
  }
  if (!variants) {
    return fetch_computed_data(country, category);
  }

  for (i = 0; i < variants.length; i++) {
    var series = wtid.countries[country][variants[i]];
    if (series) {
      for (j = 0; j < series.length; j++) {
        var year = series[j][0], value = series[j][1];
        if (!(year in combined)) {
          combined[year] = value;
        }
      }
    }
  }
  var ret = [];
  var years = Object.keys(combined).sort();
  for (i = 0; i < years.length; i++) {
    ret.push([years[i], combined[years[i]]]);
  }
  return ret;
}

var grid = {};
var mouseover = {};


function draw_chart() {
  var table = [['year']];
  var years = {};
  var col = 0;

  var countries = Object.keys(wtid.countries).sort();
  var serialize = [];
  for (var j = 0; j < countries.length; j++) {
    var country = countries[j];
    for (var i = 0; i < wtid_series().length; i++) {
      var category = wtid_series()[i].category;
      var g = grid[country][category];
      if (g.displayed) {
        serialize = serialize.concat([country, category]);
      }
      if (g.displayed || country == mouseover.country && category == mouseover.category) {
        var data = fetch_data(country, category);
        table[0][col + 1] = country + ': ' + category;
        for (var k = 0; k < data.length; k++) {
          var year = data[k][0], value = data[k][1];
          if (!(year in years)) {
            years[year] = {};
          }
          years[year][col] = value;
        }
        col += 1;
      }
    }
  }
  current_hash = window.btoa(serialize.join('|').replace(/=/g, ''));
  console.log('Setting hash to ' + current_hash);
  window.location.hash = current_hash;

  var yearnos = Object.keys(years).sort();
  for (var i = 0; i < yearnos.length; i++) {
    var year = yearnos[i];
    var row = [year];
    for (var j = 0; j < col; j++) {
      row.push(years[year][j]);
    }
    table.push(row);
  }

  if (col) {
    $('#chart').show();
    chart.draw(google.visualization.arrayToDataTable(table));
  } else {
    $('#chart').hide();
  }
}

function set_grid_display(g, displayed) {
  if (g.displayed != displayed) {
    g.displayed = displayed;
    g.element.css('background-color', g.displayed ? 'yellow' : 'white');
  }
}

function clear_wtid_series() {
  console.log('clear all series');
  var countries = Object.keys(wtid.countries).sort();
  for (var j = 0; j < countries.length; j++) {
    var country = countries[j];
    for (var i = 0; i < wtid_series().length; i++) {
      set_grid_display(grid[country][wtid_series()[i].category], false);
    }
  }
}

function toggle_series(e) {
  var series = e.data;
  var start = new Date();
  console.log(series);
  console.log('toggle series ' + JSON.stringify(series));
  var g = grid[series.country][series.category];
  set_grid_display(g, !g.displayed);
  console.log('set ' + series.country + '|' + series.category + ' to ' + g.displayed);
  draw_chart();

  console.log('toggle_series took ' + (new Date() - start));
}

function mouseenter(e) {
  mouseover = e.data;
  draw_chart();
}

function mouseleave(e) {
  mouseover = {};
  draw_chart();
}

var current_hash = null;

function read_hash() {
  var new_hash = window.location.hash.slice(1);
  if (new_hash != current_hash) {
    clear_wtid_series();
    current_hash = new_hash;
    console.log('current_hash is ' + current_hash);
    var deserialized = window.atob(current_hash).split('|');
    console.log('deserialized is ' + deserialized);
    console.log(deserialized);
    while (deserialized.length >= 2) {
      set_grid_display(grid[deserialized.shift()][deserialized.shift()], true);
    }
    draw_chart();
  }
}

var wtid_series_cached;

function wtid_series() {
  if (!wtid_series_cached) {
    wtid_series_cached = [];
    for (var i = 0; i < wtid.series.length; i++) {
      var s = wtid.series[i];
      wtid_series_cached.push(s);
      if (s.category.match(/ average income/)) {
        var computed_category = s.category.replace(' average income', ' / bottom 90% income');
        computed_source[computed_category] = s.category;
        wtid_series_cached.push({category: computed_category});
      }
    }
  }
  return wtid_series_cached;
}

function init_wtid(data) {
  wtid = data;
  /// Create table of countries and series
  
  var header = $('<tr>');
  header.append($('<td>'));
  for (var i = 0; i < wtid_series().length; i++) {
    var series = wtid_series()[i];
    header.append($('<td>').append(series.category));
  }
  $('#grid').append(header);

  var countries = Object.keys(wtid.countries).sort();
  for (var j = 0; j < countries.length; j++) {
    var country = countries[j];
    grid[country] = {};
    var row = $('<tr>');
    row.append($('<td>').append(country));
    for (var i = 0; i < wtid_series().length; i++) {
      var series = wtid_series()[i];
      var col = $('<td>');
      grid[country][series.category] = {displayed:false, element:col, hilit:false};
      var data = fetch_data(country, series.category);
      if (data.length) {
        col.append(data.length);
        col.click({country:country, category:series.category}, toggle_series);
        col.mouseenter({country:country, category:series.category}, mouseenter);
        col.mouseleave({country:country, category:series.category}, mouseleave);
      }
      row.append(col);
    }
    $('#grid').append(row);
  }
  $('#grid').parent().scroll(function(e){
    $('#gridtop').children().css({position:'relative', left:-this.scrollLeft + 'px'});
    $('#gridleft').children().css({position:'relative', top:-this.scrollTop + 'px'});
  });
  $('#gridtop').append($('#grid').clone(true,true)).css({height:$('#grid td').height() + 5});
  $('#gridleft').append($('#grid').clone(true,true)).css({width:$('#grid td').width() + 5});
  $('#gridtopleft').css({width:$('#gridleft').width() - 2,height:$('#gridtop').height() - 2});
  read_hash();
}

function init() {
  example();
  $.get('wtid.json', init_wtid);
  $(window).on('hashchange', read_hash);
}

google.load("visualization", "1", {packages:["corechart"]});
google.setOnLoadCallback(init);

</script>

</head>
<body style="height:100%">
<div id="gridtopleft" style="border:1px solid black; z-index:11; height:50px; position: absolute; background-color:#eee; width:100%; overflow:hidden"></div>
<div id="gridtop" style="z-index:10; height:50px; position: absolute; background-color:#eee; width:100%; overflow:hidden"></div>
<div id="gridleft" style="z-index:10; height:50%; position: absolute; background-color:#eee; width:100px; overflow:hidden"></div>
<div style="height:50%; width:100%; overflow:auto"><table id="grid"></table></div>
<div id="chart" style="show:none; height:50%; width:100%"></div>
</body>
</html>

<!DOCTYPE HTML>
<html>
<head>
  <title>World Top Income Database</title>
  <style type="text/css">
    body, p, table, tr, td, div, span {
      font-size: 8pt;
      font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
    }

    .noselect, label {
      -moz-user-select: none;
      -webkit-user-select: none;
      -webkit-text-size-adjust: none;
      -ms-user-select: none;
      user-select: none;
    }

    .title_text {
      text-align: center;
      font-size: 20pt;
    }

    #loading_panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 1000;
      padding: 10px;
      text-align: center;
      font-size: 50pt;
    }

    #map_canvas {
      border: 1px solid black;
      width: 890px;
      height: 430px;
      /*width: 1024px;*/
      /*height: 500px;*/
    }

    #animation_controls {
      width: 870px;
      border: 1px solid black;
      border-top: none;
      padding: 10px;
    }

    #date_slider {
      width: 600px;
      margin-left: 10px;
      margin-right: 10px;
    }

    /* turns off the focus highlight for the slider handle */
    .ui-slider-handle {
      outline: none;
    }

    #current_year {
      margin-left: 10px;
      font-size: 12pt;
      font-weight: bold;
    }

    .slider-arrow {
      cursor: pointer;
      margin: 0 5px 0 5px;
      font-weight: bold;
      font-size: 10pt;
    }

    #chart {
      border: 1px solid black;
      border-top: none;
      display: none;
      width: auto;
      height: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    #country_list {
      display: table;
    }

    .country_list_item label, .country_list_item input {
      cursor: pointer;
    }

    .country_list_checkbox, .country_list_label, .country_list_item_color_container {
      display: table-cell;
    }

    .country_list_item_color_container {
      padding-left: 5px;
    }

    .country_list_item_color {
      height: 10px;
      width: 10px;
      background-color: red;
    }

    .inactive {
      color: #cccccc;
      cursor: default;
    }
  </style>
  <link type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" rel="stylesheet"/>
  <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC7ujry5lHgjxKODXbWfsQ5oM9XgSK6WXA&sensor=false"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
  <script type="text/javascript" src="js/series.js"></script>
  <script type="text/javascript" src="lib/commons-javascript/org/cmucreatelab/util/Arrays.js"></script>
  <script type="text/javascript">

    // Generated this set at http://tools.medialab.sciences-po.fr/iwanthue/
    var COUNTRY_COLORS = [
      "#A77234", "#D052D5", "#6ADB4B", "#70D4D1", "#403C5B", "#D23E6A",
      "#C99CDA", "#C9CF7B", "#6FE19A", "#53662B", "#6B9CC4", "#CCDD40",
      "#CF3C33", "#547470", "#742F21", "#733C83", "#896CDD", "#6A9F37",
      "#3B3726", "#B99278", "#D8AB3B", "#D1499B", "#C8C2CC", "#D9746B",
      "#6E2B45", "#C1D6B0", "#5A74C1", "#589E6D", "#BF7C9B", "#DF6926"
    ];

    // from colorbrewer2.org
    var PALETTE = ['rgb(255,255,204)', 'rgb(255,237,160)', 'rgb(254,217,118)', 'rgb(254,178,76)', 'rgb(253,141,60)', 'rgb(252,78,42)', 'rgb(227,26,28)', 'rgb(189,0,38)', 'rgb(128,0,38)'];

    // from http://web-tech.ga-usa.com/2012/05/creating-a-custom-hot-to-cold-temperature-color-gradient-for-use-with-rrdtool/
    //var PALETTE = ["#0500ff", "#0400ff", "#0300ff", "#0200ff", "#0100ff", "#0000ff", "#0002ff", "#0012ff", "#0022ff",
    //               "#0032ff", "#0044ff", "#0054ff", "#0064ff", "#0074ff", "#0084ff", "#0094ff", "#00a4ff", "#00b4ff",
    //               "#00c4ff", "#00d4ff", "#00e4ff", "#00fff4", "#00ffd0", "#00ffa8", "#00ff83", "#00ff5c", "#00ff36",
    //               "#00ff10", "#17ff00", "#3eff00", "#65ff00", "#8aff00", "#b0ff00", "#d7ff00", "#fdff00", "#fffa00",
    //               "#fff000", "#ffe600", "#ffdc00", "#ffd200", "#ffc800", "#ffbe00", "#ffb400", "#ffaa00", "#ffa000",
    //               "#ff9600", "#ff8c00", "#ff8200", "#ff7800", "#ff6e00", "#ff6400", "#ff5a00", "#ff5000", "#ff4600",
    //               "#ff3c00", "#ff3200", "#ff2800", "#ff1e00", "#ff1400", "#ff0a00", "#ff0000", "#ff0010", "#ff0020",
    //               "#ff0030", "#ff0040", "#ff0050", "#ff0060", "#ff0070", "#ff0080", "#ff0090", "#ff00a0", "#ff00b0",
    //               "#ff00c0", "#ff00d0", "#ff00e0", "#ff00f0", "#ff01f0", "#ff02f0", "#ff03f0", "#ff04f0", "#ff05f0",
    //               "#ff06f0", "#ff07f0", "#ff08f0", "#ff09f0", "#ff0af0", "#ff0bf0", "#ff0cf0", "#ff0df0", "#ff0ef0"];

    var DEFAULT_COUNTRY_FILL_COLOR = "#333333";
    var DEFAULT_COUNTRY_STROKE_COLOR = "#ffffff";
    var SELECTED_COUNTRY_STROKE_COLOR = "#000000";
    var NO_DATA_FILL_OPACITY = 0.5;
    var HAS_DATA_FILL_OPACITY = 0.9;

    var DATASETS = {
      "Top 1% income share" : {valueRange : {min : 0, max : 20}},
      "Top 10% income share" : {valueRange : {min : 20, max : 45}},
      //"Top 1% average income" : {}
      //"Top 10% average income" : {}
      //"Bottom 90% average income" : {}
      "Top 1% / bottom 90% income" : {valueRange : {min : 0, max : 30}},
      "Top 10% / bottom 90% income" : {valueRange : {min : 0, max : 8}}
    };

    var COUNTRY_GEOMETRY_QUERY = "SELECT 'Name', 'geometry' FROM 1uL8KJV0bMb7A8-SkrIe0ko2DMtSypHX52DatEE4 ORDER BY Name";

    var map = null;
    var isMapLoaded = false;
    var isDataLoaded = false;
    var isCountryGeometryLoaded = false;
    var initializationIntervalHandle = null;
    var currentlySelectedCountries = {};
    var currentHash = null;

    // raw query results
    var countryGeometryRecords = null;

    // map of country name to and object containing "polygon" and "color" fields, used for rendering on map and in chart
    var countryToRendering = {};

    var dateSlider = null;
    var selectedYear = 2014;

    function executeQuery(query, successCallback) {
      // Construct the URL
      var url = ['https://www.googleapis.com/fusiontables/v1/query'];
      url.push('?sql=' + query);
      url.push('&key=AIzaSyC7ujry5lHgjxKODXbWfsQ5oM9XgSK6WXA');
      url.push('&callback=?');

      var theUrl = url.join('');

      // Send the JSONP request using jQuery
      $.ajax({
               url : theUrl,
               dataType : 'jsonp',
               success : successCallback,
               error : function(jqXHR, textStatus, errorThrown) {
                 console.log("AJAX ERROR: [" + textStatus + "] and [" + errorThrown + "]");
               }
             });
    }

    function loadData() {

      // Load the WTID data
      $.get('wtid-2014-04-25.json', function(data) {
        console.log("Data loaded!");
        wtid = data;
        isDataLoaded = true;
      });

      // Load the country geometries.  Yeah, I know I could make this more efficient by only loading the countries
      // which have WTID data, but then I'd need to serialize the data fetching calls, so...whatever.
      executeQuery(COUNTRY_GEOMETRY_QUERY,
                   function(data) {
                     console.log("Geometries loaded!");
                     countryGeometryRecords = data;
                     isCountryGeometryLoaded = true;
                   }
      );

      // initialize and load the map
      map = new google.maps.Map(document.getElementById("map_canvas"), {
        center : new google.maps.LatLng(15.284185050572193, 27.86132825000005),
        //center : new google.maps.LatLng(17.97873303293798, 11.33789075000005),
        zoom : 2,
        mapTypeId : google.maps.MapTypeId.ROADMAP
      });
      google.maps.event.addListenerOnce(map, 'tilesloaded',
                                        function(e) {
                                          console.log("Map loaded!");
                                          isMapLoaded = true;

                                        });

      // Kick of an interval timer to keep checking whether all the various data sources have finished loading.  Once
      // loaded, we'll call init() to initialize the UI and the hide the Loading panel.
      initializationIntervalHandle = window.setInterval(function() {
        console.log("checking whether data, map, and geometries have loaded...");
        if (isDataLoaded && isMapLoaded && isCountryGeometryLoaded) {
          window.clearInterval(initializationIntervalHandle);
          initializationIntervalHandle = null;
          console.log("Done loading!");

          // cache the data in a way that makes animation easier
          cacheData();

          init();
        }
      }, 200);
    }

    function init() {

      // build the dataset select menu
      Object.keys(DATASETS).forEach(function(name) {
        var option = $('<option value="' + name + '">' + name + '</option>');
        $("#datasets").append(option);
      });
      $("#datasets").change(function() {
        updateDatasetAvailabilityForCountries();
        updateChart();
        updateMap();

        // TODO: set the slider to a valid year if the currently selected year isn't in this new dataset

        updateHash();
      });

      // build the date slider and animation controls
      dateSlider = $("#date_slider");
      dateSlider.slider({
                          min : getSelectedDatasetYearRange()['min'],
                          max : getSelectedDatasetYearRange()['max'],
                          value : getSelectedDatasetYearRange()['max'],
                          change : handleSliderChange,
                          slide : handleSliderChange
                        });
      $("#arrow_beginning").click(function() {
        dateSlider.slider("option", "value", getSelectedDatasetYearRange()['min']);
      });
      $("#arrow_previous").click(function() {
        var newVal = Math.max(getSelectedDatasetYearRange()['min'], dateSlider.slider("option", "value") - 1);
        dateSlider.slider("option", "value", newVal);
      });
      $("#arrow_next").click(function() {
        var newVal = Math.min(getSelectedDatasetYearRange()['max'], dateSlider.slider("option", "value") + 1);
        dateSlider.slider("option", "value", newVal);
      });
      $("#arrow_end").click(function() {
        dateSlider.slider("option", "value", getSelectedDatasetYearRange()['max']);
      });

      // build the country name to polygon map, render the polygons on the map
      buildCountryRenderings();

      updateDatasetAvailabilityForCountries();

      $(window).on('hashchange', readHash);
      readHash();

      // simulate a click to set the slider to the max value--this
      // has the side effect of setting the current year label too
      $("#arrow_end").click();

      $("#loading_panel").hide();
      $("#main_panel").show();
    }

    function handleSliderChange(event, ui) {
      var year = ui.value;
      $("#current_year").text(year);

      selectedYear = year;

      updateMap();
    }

    function buildCountryRenderings() {
      Object.keys(wtid.countries).forEach(function(countryName) {
        countryToRendering[countryName] = {};
      });
      var numCountriesFound = 0;
      $.each(countryGeometryRecords['rows'], function(index, countryGeometryRecord) {
               var countryName = countryGeometryRecord[0];

               var createPolygon = function(paths) {
                 return new google.maps.Polygon({
                                                  paths : paths,
                                                  strokeColor : DEFAULT_COUNTRY_STROKE_COLOR,
                                                  strokeOpacity : 0.8,
                                                  strokeWeight : 1,
                                                  fillColor : DEFAULT_COUNTRY_FILL_COLOR,
                                                  fillOpacity : NO_DATA_FILL_OPACITY
                                                });
               };

               // if this is a country with WTID data, then get its geometry
               if (countryToRendering.hasOwnProperty(countryName)) {

                 // Deal with the two different kinds of geometries: Polygons and GeometryCollections
                 var geometry = countryGeometryRecord[1];
                 var polygon = null;
                 if (geometry['geometry'] && geometry['geometry']['type'] && geometry['geometry']['type'] == "Polygon") {

                   var latLongs = [];
                   var coordinates = geometry['geometry']['coordinates'][0];
                   for (var i = 0; i < coordinates.length; i++) {
                     latLongs.push(new google.maps.LatLng(coordinates[i][1], coordinates[i][0]));
                   }
                   polygon = createPolygon(latLongs);

                 } else if (geometry['type'] && geometry['type'] == "GeometryCollection") {

                   var multiLatLongs = [];
                   for (var j = 0; j < geometry['geometries'].length; j++) {
                     var geometryPiece = geometry['geometries'][j];
                     var latLongs = [];

                     var coordinates = geometryPiece['coordinates'][0];
                     for (var i = 0; i < coordinates.length; i++) {
                       latLongs.push(new google.maps.LatLng(coordinates[i][1], coordinates[i][0]));
                     }
                     multiLatLongs.push(latLongs);
                   }
                   polygon = createPolygon(multiLatLongs);
                 } else {
                   console.log("Ingoring unexpected geometry type for country [" + countryName + "]: " + JSON.stringify(geometry));
                 }

                 if (polygon != null) {
                   countryToRendering[countryName]['polygon'] = polygon;
                   countryToRendering[countryName]['color'] = COUNTRY_COLORS[numCountriesFound % COUNTRY_COLORS.length];
                   numCountriesFound++;

                   polygon.setMap(map);
                   google.maps.event.addListener(polygon,
                                                 'click',
                                                 function() {
                                                   toggleCountry(countryName);
                                                   updateHash();
                                                 });

                   // add the country to the list
                   var cleanedCountryName = stripAllNonAlpha(countryName);
                   var checkboxId = "country_list_checkbox" + cleanedCountryName;

                   var countryListItem = $('<div style="display: table-row;" class="country_list_item" id="country_list_item' + cleanedCountryName + '">' +
                                           '   <div class="country_list_item_color_container">' +
                                           '      <div id="country_list_item_color'+cleanedCountryName+'" class="country_list_item_color"></div>' +
                                           '   </div>' +
                                           '   <input style="display: table-cell;" type="checkbox" class="country_list_checkbox" id="' + checkboxId + '" name="selected_countries" value="' + countryName + '">' +
                                           '   <label for="country_list_checkbox' + cleanedCountryName + '" class="country_list_label">' + countryName + '</label>' +
                                           '</div>').change(function() {
                     toggleCountry($("#" + checkboxId).val());
                     updateHash();
                   });
                   $("#country_list").append(countryListItem);
                 }
               }
             }
      );
    }

    /**
     * Returns the given string with all non-alphabetic characters removed.  Returns the string unchanged if the string
     * is undefined or null.
     *
     * @returns {string}
     */
    function stripAllNonAlpha(str) {
      if (str) {
        return str.replace(/[^a-zA-Z]/g, '');
      }

      return str;
    }

    function toggleCountry(countryName) {

      if (typeof countryToRendering[countryName] !== 'undefined') {
        var polygon = countryToRendering[countryName]['polygon'];
        if (polygon) {
          // if the country is already selected...
          var isSelected = currentlySelectedCountries.hasOwnProperty(countryName);

          // Setting the map to null here, and then to the map after setting the polygon options fixes a bug where the
          // new polygon options occasionally aren't honored.
          polygon.setMap(null);
          if (isSelected) {
            polygon.setOptions({
                                 strokeColor : DEFAULT_COUNTRY_STROKE_COLOR,
                                 strokeOpacity : 0.8
                               });

            // remove the country from the set of selected countries
            delete currentlySelectedCountries[countryName];
          }
          // if the country isn't already selected
          else {
            currentlySelectedCountries[countryName] = 1;
            polygon.setOptions({
                                 strokeColor : SELECTED_COUNTRY_STROKE_COLOR,
                                 strokeOpacity : 1
                               });
          }
          polygon.setMap(map);

          // update the radio button
          $("#country_list_checkbox" + stripAllNonAlpha(countryName)).prop("checked", !isSelected);

          updateChart();
        }
      }
    }

    function getSelectedDatasetName() {
      return $("#datasets").val();
    }

    function getSelectedDatasetYearRange() {
      return DATASETS[getSelectedDatasetName()]['yearRange'];
    }

    function updateMap() {
      var dataset = getSelectedDatasetName();
      var data = DATASETS[dataset]['data'];
      Object.keys(wtid.countries).forEach(function(countryName) {
        setCountryColor(countryName, null);
        if (typeof data[countryName] !== 'undefined') {
          // first see if there's a value for the selected year
          var value = data[countryName][selectedYear];

          // if not, try to find a previous value
          if (typeof value === 'undefined') {
            var years = data[countryName]['years'];
            var index = null;
            if (selectedYear < years[0]) {
              index = null;
            }
            else if (selectedYear > years[years.length - 1]) {
              index = years.length - 1;
            }
            else {
              index = org.cmucreatelab.util.Arrays.binarySearch(years, selectedYear, org.cmucreatelab.util.Arrays.NUMERIC_COMPARATOR);
              if (index < 0) {
                index = ~index - 1;
              }
              else {
                // If the selectedYear exists in the years array, then we want the PREVIOUS one.  Need to be careful about
                // the case were we ask for--and get--the very first element in the array.  There is no previous element
                // in that case, so return null.
                index = index - 1;

                if (index < 0) {
                  index = null;
                }
              }
            }

            // if we found an index, then get the value for the year pointed to by the index
            if (index != null) {
              value = data[countryName][years[index]];
            }
          }

          // if we have a value now, then render it
          if (typeof value !== 'undefined' && value != null) {
            setCountryColor(countryName, getColorForValue(DATASETS[dataset]['valueRange'], value));
          }
        }
      });
    }

    function getColorForValue(valueRange, value) {
      // clamp the value to be within the allowed range
      var clampedValue = Math.min(Math.max(value, valueRange['min']), valueRange['max']);

      var numBuckets = PALETTE.length;
      var percentage = (clampedValue - valueRange['min']) / (valueRange['max'] - valueRange['min']);   // convert to [0,1]
      var colorIndex = Math.max(0, Math.ceil(percentage * numBuckets) - 1);
      return PALETTE[colorIndex];
    }

    function setCountryColor(countryName, color) {
      var options;
      if (color) {
        options = {
          "fillColor" : color,
          fillOpacity : HAS_DATA_FILL_OPACITY
        };
      } else {
        options = {
          "fillColor" : DEFAULT_COUNTRY_FILL_COLOR,
          fillOpacity : NO_DATA_FILL_OPACITY
        };
      }
      $("#country_list_item_color" + stripAllNonAlpha(countryName)).css("background-color", color ? color : "#ffffff");
      countryToRendering[countryName]['polygon'].setOptions(options);
    }

    function cacheData() {
      Object.keys(DATASETS).forEach(function(datasetName) {
        DATASETS[datasetName]['data'] = {};

        var yearRange = {min : Number.MAX_VALUE, max : Number.MIN_VALUE};
        Object.keys(wtid.countries).forEach(function(countryName) {
          var years = [];
          var data = fetch_data(countryName, datasetName);
          DATASETS[datasetName]['data'][countryName] = {};
          for (var i = 0; i < data.length; i++) {
            var year = data[i][0];
            years.push(year);
            yearRange['min'] = Math.min(year, yearRange['min']);
            yearRange['max'] = Math.max(year, yearRange['max']);
            DATASETS[datasetName]['data'][countryName][year] = data[i][1];
          }
          DATASETS[datasetName]['data'][countryName]['years'] = years.sort();
        });
        DATASETS[datasetName]['yearRange'] = yearRange;

      });
    }

    // Toggle each country's polygon and list item depending on whether the country has data for the selected dataset
    function updateDatasetAvailabilityForCountries() {
      var dataset = getSelectedDatasetName();

      Object.keys(wtid.countries).forEach(function(countryName) {
        var isDatasetNonEmpty = hasData(countryName, dataset);

        // toggle the polygon visibility
        countryToRendering[countryName]['polygon'].setMap(isDatasetNonEmpty ? map : null);

        // toggle the list item enabled/disabled
        var listItemId = "country_list_item" + stripAllNonAlpha(countryName);
        var checkboxId = "country_list_checkbox" + stripAllNonAlpha(countryName);
        if (isDatasetNonEmpty) {
          $("#" + listItemId).removeClass("inactive");
          $("#" + checkboxId).removeAttr("disabled");
        } else {
          $("#" + listItemId).addClass("inactive");
          $("#" + checkboxId).attr("disabled", true);
        }
      });
    }

    function updateChart() {
      // update and show the chart if there are selected countries.  Otherwise, hide it.
      var series = [];
      if (Object.keys(currentlySelectedCountries).length > 0) {
        Object.keys(currentlySelectedCountries).sort().forEach(function(countryName) {
          var dataset = getSelectedDatasetName();
          if (hasData(countryName, dataset)) {
            series.push({country : countryName, category : dataset, color : countryToRendering[countryName]['color']})
          }
        });
      }

      if (series.length > 0) {
        draw_chart(series);
        $("#chart").show();
      }
      else {
        $("#chart").hide();
      }
    }

    function updateHash() {
      currentHash = window.btoa(getSelectedDatasetName() + "|" + Object.keys(currentlySelectedCountries).join('|'));
      //console.log("updateHash(): " + window.atob(currentHash).split('|'));
      window.location.hash = currentHash;
    }

    function readHash() {
      var newHash = window.location.hash.slice(1);
      if (newHash != currentHash) {
        currentHash = newHash;

        // deselect all countries
        Object.keys(currentlySelectedCountries).sort().forEach(function(countryName) {
          toggleCountry(countryName);
        });

        if (newHash.length > 0) {
          var deserialized = window.atob(currentHash).split('|');
          //console.log('currentHash: ' + currentHash);
          //console.log('deserialized: ' + deserialized);

          // the dataset is stored in the first element.
          $("#datasets").val(deserialized.shift());

          // all the rest are countries
          while (deserialized.length > 0) {
            toggleCountry(deserialized.shift());
          }
        }
      }
    }

    google.load("visualization", "1", {packages : ["corechart"]});
    google.setOnLoadCallback(loadData);
  </script>
</head>
<body>
<div id="loading_panel">Loading...</div>
<div id="main_panel">
  <table border="0" cellpadding="0" cellspacing="0" style="width:auto; margin-left: auto; margin-right: auto">
    <tr valign="top">
      <td>
        <div id="map_canvas" class="noselect"></div>
        <div id="animation_controls" class="noselect">
          <table border="0" cellpadding="0" cellspacing="0" align="center">
            <tr>
              <td align="left">
                <button id="start_stop_animation_button">Play</button>
                <select id="animation_interval_millis">
                  <option value="1000">1 fps</option>
                  <option value="500">2 fps</option>
                  <option value="200">5 fps</option>
                  <option value="100" selected="selected">10 fps</option>
                  <option value="40">25 fps</option>
                  <option value="10">100 fps</option>
                </select>
              </td>
              <td>
                <div id="arrow_beginning" class="slider-arrow">|&lt;</div>
              </td>
              <td>
                <div id="arrow_previous" class="slider-arrow">&lt;</div>
              </td>
              <td>
                <div id="date_slider"></div>
              </td>
              <td>
                <div id="arrow_next" class="slider-arrow">&gt;</div>
              </td>
              <td>
                <div id="arrow_end" class="slider-arrow">&gt;|</div>
              </td>
              <td align="right">
                <div id="current_year">2014</div>
              </td>
            </tr>
          </table>
        </div>
        <div id="chart" class="noselect"></div>
      </td>
      <td rowspan="3" valign="top">
        <select id="datasets"></select>
        <div id="country_list" class="noselect"></div>
      </td>
    </tr>
  </table>
</div>
</body>
</html>
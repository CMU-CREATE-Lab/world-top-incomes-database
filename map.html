<!DOCTYPE HTML>
<html>
<head>
  <title>World Top Income Database</title>
  <style type="text/css">
    body, p, table, tr, td, div, span {
      font-size: 8pt;
      font-family: "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
    }

    .noselect, label {
      -moz-user-select: none;
      -webkit-user-select: none;
      -webkit-text-size-adjust: none;
      -ms-user-select: none;
      user-select: none;
    }

    .title_text {
      text-align: center;
      font-size: 20pt;
    }

    #loading_panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 1000;
      padding: 10px;
      text-align: center;
      font-size: 50pt;
    }

    #map_canvas {
      border: 1px solid black;
      width: 890px;
      height: 430px;
      /*width: 1024px;*/
      /*height: 500px;*/
    }

    #chart {
      border: 1px solid black;
      border-top: none;
      display: none;
      width: auto;
      height: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .country_list_item label, .country_list_item input {
      cursor: pointer;
    }

    .inactive {
      color: #cccccc;
      cursor: default;
    }
  </style>
  <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC7ujry5lHgjxKODXbWfsQ5oM9XgSK6WXA&sensor=false"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script type="text/javascript" src="js/series.js"></script>
  <script type="text/javascript">

    // Generated this set at http://tools.medialab.sciences-po.fr/iwanthue/
    var COUNTRY_COLORS = [
      "#A77234", "#D052D5", "#6ADB4B", "#70D4D1", "#403C5B", "#D23E6A",
      "#C99CDA", "#C9CF7B", "#6FE19A", "#53662B", "#6B9CC4", "#CCDD40",
      "#CF3C33", "#547470", "#742F21", "#733C83", "#896CDD", "#6A9F37",
      "#3B3726", "#B99278", "#D8AB3B", "#D1499B", "#C8C2CC", "#D9746B",
      "#6E2B45", "#C1D6B0", "#5A74C1", "#589E6D", "#BF7C9B", "#DF6926"
    ];

    var DEFAULT_COUNTRY_FILL_COLOR = "#333333";

    var DATASETS = [
      "Top 1% income share",
      "Top 10% income share",
      //"Top 1% average income",
      //"Top 10% average income",
      //"Bottom 90% average income",
      "Top 1% / bottom 90% income",
      "Top 10% / bottom 90% income"
    ];
    var COUNTRY_GEOMETRY_QUERY = "SELECT 'Name', 'geometry' FROM 1uL8KJV0bMb7A8-SkrIe0ko2DMtSypHX52DatEE4 ORDER BY Name";
    var map = null;
    var isMapLoaded = false;
    var isDataLoaded = false;
    var isCountryGeometryLoaded = false;
    var initializationIntervalHandle = null;
    var currentlySelectedCountries = {};
    var currentHash = null;

    // raw query results
    var countryGeometryRecords = null;

    // map of country name to and object containing "polygon" and "color" fields, used for rendering on map and in chart
    var countryToRendering = {};

    function executeQuery(query, successCallback) {
      // Construct the URL
      var url = ['https://www.googleapis.com/fusiontables/v1/query'];
      url.push('?sql=' + query);
      url.push('&key=AIzaSyC7ujry5lHgjxKODXbWfsQ5oM9XgSK6WXA');
      url.push('&callback=?');

      var theUrl = url.join('');

      // Send the JSONP request using jQuery
      $.ajax({
               url : theUrl,
               dataType : 'jsonp',
               success : successCallback,
               error : function(jqXHR, textStatus, errorThrown) {
                 console.log("AJAX ERROR: [" + textStatus + "] and [" + errorThrown + "]");
               }
             });
    }

    function loadData() {

      // Load the WTID data
      $.get('wtid-2014-04-25.json', function(data) {
        console.log("Data loaded!");
        wtid = data;
        isDataLoaded = true;
      });

      // Load the country geometries.  Yeah, I know I could make this more efficient by only loading the countries
      // which have WTID data, but then I'd need to serialize the data fetching calls, so...whatever.
      executeQuery(COUNTRY_GEOMETRY_QUERY,
                   function(data) {
                     console.log("Geometries loaded!");
                     countryGeometryRecords = data;
                     isCountryGeometryLoaded = true;
                   }
      );

      // initialize and load the map
      map = new google.maps.Map(document.getElementById("map_canvas"), {
        center : new google.maps.LatLng(15.284185050572193, 27.86132825000005),
        //center : new google.maps.LatLng(17.97873303293798, 11.33789075000005),
        zoom : 2,
        mapTypeId : google.maps.MapTypeId.ROADMAP
      });
      google.maps.event.addListenerOnce(map, 'tilesloaded',
                                        function(e) {
                                          console.log("Map loaded!");
                                          isMapLoaded = true;

                                        });

      // Kick of an interval timer to keep checking whether all the various data sources have finished loading.  Once
      // loaded, we'll call init() to initialize the UI and the hide the Loading panel.
      initializationIntervalHandle = window.setInterval(function() {
        console.log("checking whether data, map, and geometries have loaded...");
        if (isDataLoaded && isMapLoaded && isCountryGeometryLoaded) {
          window.clearInterval(initializationIntervalHandle);
          initializationIntervalHandle = null;
          console.log("Done loading!");

          init();
        }
      }, 200);
    }

    function init() {

      // build the dataset select menu
      DATASETS.forEach(function(name) {
        var option = $('<option value="' + name + '">' + name + '</option>');
        $("#datasets").append(option);
      });
      $("#datasets").change(function() {
        updateDatasetAvailabilityForCountries();
        updateChart();
        updateHash();
      });

      // build the country name to polygon map, render the polygons on the map
      buildCountryRenderings();

      $(window).on('hashchange', readHash);
      readHash();
      updateDatasetAvailabilityForCountries();

      $("#loading_panel").hide();
      $("#main_panel").show();
    }

    function buildCountryRenderings() {
      Object.keys(wtid.countries).forEach(function(countryName) {
        countryToRendering[countryName] = {};
      });
      var numCountriesFound = 0;
      $.each(countryGeometryRecords['rows'], function(index, countryGeometryRecord) {
               var countryName = countryGeometryRecord[0];

               var createPolygon = function(paths) {
                 return new google.maps.Polygon({
                                                  paths : paths,
                                                  strokeColor : "#ffffff",
                                                  strokeOpacity : 0.8,
                                                  strokeWeight : 1,
                                                  fillColor : DEFAULT_COUNTRY_FILL_COLOR,
                                                  fillOpacity : 0.5
                                                });
               };

               // if this is a country with WTID data, then get its geometry
               if (countryToRendering.hasOwnProperty(countryName)) {

                 // Deal with the two different kinds of geometries: Polygons and GeometryCollections
                 var geometry = countryGeometryRecord[1];
                 var polygon = null;
                 if (geometry['geometry'] && geometry['geometry']['type'] && geometry['geometry']['type'] == "Polygon") {

                   var latLongs = [];
                   var coordinates = geometry['geometry']['coordinates'][0];
                   for (var i = 0; i < coordinates.length; i++) {
                     latLongs.push(new google.maps.LatLng(coordinates[i][1], coordinates[i][0]));
                   }
                   polygon = createPolygon(latLongs);

                 } else if (geometry['type'] && geometry['type'] == "GeometryCollection") {

                   var multiLatLongs = [];
                   for (var j = 0; j < geometry['geometries'].length; j++) {
                     var geometryPiece = geometry['geometries'][j];
                     var latLongs = [];

                     var coordinates = geometryPiece['coordinates'][0];
                     for (var i = 0; i < coordinates.length; i++) {
                       latLongs.push(new google.maps.LatLng(coordinates[i][1], coordinates[i][0]));
                     }
                     multiLatLongs.push(latLongs);
                   }
                   polygon = createPolygon(multiLatLongs);
                 } else {
                   console.log("Ingoring unexpected geometry type for country [" + countryName + "]: " + JSON.stringify(geometry));
                 }

                 if (polygon != null) {
                   countryToRendering[countryName]['polygon'] = polygon;
                   countryToRendering[countryName]['color'] = COUNTRY_COLORS[numCountriesFound % COUNTRY_COLORS.length];
                   numCountriesFound++;

                   polygon.setMap(map);
                   google.maps.event.addListener(polygon,
                                                 'click',
                                                 function() {
                                                   toggleCountry(countryName);
                                                   updateHash();
                                                 });

                   // add the country to the list
                   var cleanedCountryName = stripAllNonAlpha(countryName);
                   var checkboxId = "country_list_checkbox" + cleanedCountryName;

                   var countryListItem = $('<div class="country_list_item" id="country_list_item' + cleanedCountryName + '">' +
                                           '   <input type="checkbox" class="country_list_checkbox" id="'+checkboxId+'" name="selected_countries" value="'+countryName+'">' +
                                           '   <label for="country_list_checkbox'+cleanedCountryName +'">'+countryName+'</label>' +
                                           '</div>').change(function(){
                     toggleCountry($("#" + checkboxId).val());
                     updateHash();
                   });
                   $("#countryList").append(countryListItem);
                 }
               }
             }
      );
    }

    /**
     * Returns the given string with all non-alphabetic characters removed.  Returns the string unchanged if the string
     * is undefined or null.
     *
     * @returns {string}
     */
    function stripAllNonAlpha(str) {
      if (str) {
        return str.replace(/[^a-zA-Z]/g, '');
      }

      return str;
    }

    function toggleCountry(countryName) {

      if (typeof countryToRendering[countryName] !== 'undefined') {
        var polygon = countryToRendering[countryName]['polygon'];
        if (polygon) {
          var countryColor = countryToRendering[countryName]['color'];
          // if the country is already selected...
          var isSelected = currentlySelectedCountries.hasOwnProperty(countryName);

          // Setting the map to null here, and then to the map after setting the polygon options fixes a bug where the
          // new polygon options occasionally aren't honored.
          polygon.setMap(null);
          if (isSelected) {
            polygon.setOptions({
                                 fillColor : DEFAULT_COUNTRY_FILL_COLOR,
                                 fillOpacity : 0.5
                               });

            // remove the country from the set of selected countries
            delete currentlySelectedCountries[countryName];
          }
          // if the country isn't already selected
          else {
            currentlySelectedCountries[countryName] = 1;
            polygon.setOptions({
                                 fillColor : countryColor,
                                 fillOpacity : 0.9
                               });
          }
          polygon.setMap(map);

          // update the radio button
          $("#country_list_checkbox" + stripAllNonAlpha(countryName)).prop("checked", !isSelected);


          updateChart();
        }
      }
    }

    // Toggle each country's polygon and list item depending on whether the country has data for the selected dataset
    function updateDatasetAvailabilityForCountries() {
      var dataset = $("#datasets").val();
      Object.keys(countryToRendering).forEach(function(countryName) {
        var isDatasetNonEmpty = hasData(countryName, dataset);

        // toggle the polygon visibility
        countryToRendering[countryName]['polygon'].setMap(isDatasetNonEmpty ? map : null);

        // toggle the list item enabled/disabled
        var listItemId = "country_list_item" + stripAllNonAlpha(countryName);
        var checkboxId = "country_list_checkbox" + stripAllNonAlpha(countryName);
        if (isDatasetNonEmpty) {
          $("#"+listItemId).removeClass("inactive");
          $("#"+checkboxId).removeAttr("disabled");
        } else {
          $("#"+listItemId).addClass("inactive");
          $("#"+checkboxId).attr("disabled", true);
        }
      });
    }

    function updateChart() {
      // update and show the chart if there are selected countries.  Otherwise, hide it.
      var series = [];
      if (Object.keys(currentlySelectedCountries).length > 0) {
        Object.keys(currentlySelectedCountries).sort().forEach(function(countryName) {
          var dataset = $("#datasets").val();
          if (hasData(countryName, dataset)){
            series.push({country : countryName, category : dataset, color : countryToRendering[countryName]['color']})
          }
        });
      }

      if (series.length > 0) {
        draw_chart(series);
        $("#chart").show();
      }
      else {
        $("#chart").hide();
      }
    }

    function updateHash() {
      currentHash = window.btoa($("#datasets").val() + "|" + Object.keys(currentlySelectedCountries).join('|'));
      //console.log("updateHash(): " + window.atob(currentHash).split('|'));
      window.location.hash = currentHash;
    }

    function readHash() {
      var newHash = window.location.hash.slice(1);
      if (newHash != currentHash) {
        currentHash = newHash;

        // deselect all countries
        Object.keys(currentlySelectedCountries).sort().forEach(function(countryName) {
          toggleCountry(countryName);
        });

        if (newHash.length > 0) {
          var deserialized = window.atob(currentHash).split('|');
          //console.log('currentHash: ' + currentHash);
          //console.log('deserialized: ' + deserialized);

          // the dataset is stored in the first element.
          $("#datasets").val(deserialized.shift());

          // all the rest are countries
          while (deserialized.length > 0) {
            toggleCountry(deserialized.shift());
          }
        }
      }
    }

    google.load("visualization", "1", {packages : ["corechart"]});
    google.setOnLoadCallback(loadData);
  </script>
</head>
<body>
<div id="loading_panel">Loading...</div>
<div id="main_panel">
  <table border="0" cellpadding="0" cellspacing="0" style="width:auto; margin-left: auto; margin-right: auto">
    <tr valign="top">
      <td>
        <div id="map_canvas"></div>
      </td>
      <td rowspan="2" valign="top">
        <select id="datasets"></select>
        <div id="countryList"></div>
      </td>
    </tr>
    <tr>
      <td>
        <div id="chart" class="noselect"></div>
      </td>
    </tr>
  </table>
</div>
</body>
</html>